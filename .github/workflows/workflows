name: Deploy Chat App to EC2

# This tells GitHub to run the job on every push to the 'main' branch
on:
  push:
    branches: [ main ] # Change this to 'master' if that's your default branch

jobs:
  deploy:
    # This is the crucial line: it runs the job on your EC2 machine
    runs-on: self-hosted

    steps:
      - name: 1. Check out the repository
        # This downloads your latest code onto the runner
        uses: actions/checkout@v4

      - name: 2. Set up Node.js
        # This sets up the Node.js version for the job
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*' # Use the latest Long-Term Support version

      - name: 3. Install dependencies
        # Runs 'npm install' to get all packages
        run: npm install

      - name: 4. Create .env file from secrets
        # This securely creates the .env file on your server
        run: |
          echo "MONGO_URI=${{ secrets.MONGO_URI }}" >> .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "PORT=${{ secrets.PORT }}" >> .env

      - name: 5. Restart application with PM2
        # This is the final step: it restarts your app
        # '|| true' is a safety: it starts the app if it's not already running
        run: |
          pm2 restart chat-app || pm2 start src/server.js --name chat-app